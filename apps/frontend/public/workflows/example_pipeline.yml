name: Comprehensive GitHub Actions Workflow Demo

# 1. è§¦å‘äº‹ä»¶é…ç½®
on:
  # æ¨é€äº‹ä»¶
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
    paths:
      - 'src/**'
      - '**.js'
      - '!docs/**'
  
  # æ‹‰å–è¯·æ±‚äº‹ä»¶
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      debug:
        description: 'å¯ç”¨è°ƒè¯•æ¨¡å¼'
        required: false
        type: boolean
      tags:
        description: 'è‡ªå®šä¹‰æ ‡ç­¾'
        required: false
        type: string
  
  # å®šæ—¶ä»»åŠ¡
  schedule:
    - cron: '0 2 * * 1-5'  # æ¯å‘¨ä¸€åˆ°äº”å‡Œæ™¨2ç‚¹
    - cron: '0 0 * * 0'    # æ¯å‘¨æ—¥å‡Œæ™¨
  
  # ä»“åº“äº‹ä»¶
  release:
    types: [ published ]
  
  # å·¥ä½œæµè°ƒç”¨
  workflow_call:
    inputs:
      target_env:
        required: true
        type: string
      skip_tests:
        required: false
        type: boolean
        default: false
    secrets:
      DEPLOY_KEY:
        required: true

# 2. ç¯å¢ƒå˜é‡é…ç½®
env:
  NODE_VERSION: '18.x'
  PYTHON_VERSION: '3.10'
  DOCKER_REGISTRY: 'ghcr.io'

# 3. å·¥ä½œæµæƒé™
permissions:
  contents: read
  packages: write
  issues: write
  pull-requests: write

# 4. å¹¶å‘æ§åˆ¶
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    # Job ç­–ç•¥ - ä½¿ç”¨çŸ©é˜µæ¸…æ™°å®šä¹‰
    strategy:
      matrix:
        check-type: [lint, security, coverage]
        node-version: [16.x, 18.x]
        include:
          - check-type: lint
            command: eslint
          - check-type: security
            command: audit
          - check-type: coverage
            command: test
    
    # ç¯å¢ƒé…ç½®
    environment: development
    
    # ç¯å¢ƒå˜é‡ï¼ˆJobçº§åˆ«ï¼‰
    env:
      CI: true
      TEST_ENV: matrix-check
    
    # æ¡ä»¶æ‰§è¡Œ - æ¸…æ™°çš„æ¡ä»¶åˆ¤æ–­
    if: ${{ !contains(github.event.head_commit.message, '[skip ci]') }}
    
    # é»˜è®¤æ­¥éª¤
    defaults:
      run:
        shell: bash
    
    # è¶…æ—¶è®¾ç½®
    timeout-minutes: 30
    
    steps:
    # æ­¥éª¤1: æ£€å‡ºä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4
      env:  # åœ¨ Step çº§åˆ«è®¾ç½®ç¯å¢ƒå˜é‡
          STEP_SPECIFIC_VAR: step-value
          ANOTHER_VAR: another-value
      with:
        fetch-depth: 0
        ref: ${{ github.ref }}
    
    # æ­¥éª¤2: è®¾ç½® Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    # æ­¥éª¤3: ä¾èµ–å®‰è£…
    - name: Install dependencies
      run: |
        echo "å®‰è£…ä¾èµ–åŒ…..."
        npm ci
        echo "å½“å‰æ£€æŸ¥ç±»å‹: ${{ matrix.check-type }}"
        echo "Node.js ç‰ˆæœ¬: ${{ matrix.node-version }}"
        echo "æ‰§è¡Œå‘½ä»¤: ${{ matrix.command }}"
    
    # æ­¥éª¤4: ä»£ç æ£€æŸ¥çŸ©é˜µ
    - name: Run ${{ matrix.check-type }}
      run: |
        case "${{ matrix.check-type }}" in
          "lint")
            echo "æ‰§è¡Œä»£ç è§„èŒƒæ£€æŸ¥"
            echo "ESLint æ£€æŸ¥ä¸­..."
            ;;
          "security")
            echo "æ‰§è¡Œå®‰å…¨æ¼æ´æ‰«æ"
            echo "npm audit æ£€æŸ¥ä¸­..."
            ;;
          "coverage")
            echo "æ‰§è¡Œä»£ç è¦†ç›–ç‡æ£€æŸ¥"
            echo "è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š..."
            ;;
        esac
    
    # æ­¥éª¤5: ä¸Šä¼ åˆ¶å“
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.check-type }}-results-${{ matrix.node-version }}
        path: |
          reports/
          coverage/
        retention-days: 7
      if: always()
    
    # æ­¥éª¤6: ç¼“å­˜å¤„ç†
    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

  # Job 2: æ„å»ºå’Œæµ‹è¯• - ä½¿ç”¨çŸ©é˜µè·¨å¹³å°æµ‹è¯•
  build-and-test:
    name: Build and Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    # æ¸…æ™°çš„çŸ©é˜µç­–ç•¥å®šä¹‰å¤šå¹³å°
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        node-version: [18.x]
    
    needs: code-quality
    
    # æœåŠ¡å®¹å™¨
    services:
      redis:
        image: redis
        ports:
          - 6379/tcp
        options: --health-cmd "redis-cli ping" --health-interval 10s --health-timeout 5s --health-retries 5
      
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432/tcp
    
    env:
      REDIS_URL: redis://localhost:6379
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/postgres
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup environment
      run: |
        echo "è®¾ç½®æ„å»ºç¯å¢ƒ..."
        echo "è¿è¡Œåœ¨: ${{ matrix.os }}"
        echo "å·¥ä½œç›®å½•: ${{ github.workspace }}"
        echo "äº‹ä»¶ç±»å‹: ${{ github.event_name }}"
        echo "æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}"
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
    
    - name: Build application
      id: build
      run: |
        echo "å¼€å§‹æ„å»ºåº”ç”¨ç¨‹åº..."
        echo "æ“ä½œç³»ç»Ÿ: ${{ matrix.os }}"
        echo "Node.js ç‰ˆæœ¬: ${{ matrix.node-version }}"
        echo "æ„å»ºé…ç½®: ${{ vars.BUILD_CONFIG || 'default' }}"
    
    - name: Run tests
      run: |
        echo "æ‰§è¡Œæµ‹è¯•å¥—ä»¶..."
        echo "è¿æ¥åˆ° Redis: ${{ env.REDIS_URL }}"
        echo "è¿æ¥åˆ° PostgreSQL: ${{ env.DATABASE_URL }}"
        echo "åœ¨ ${{ matrix.os }} ä¸Šè¿è¡Œæµ‹è¯•"
    
    - name: Test results
      if: always()
      run: |
        echo "æµ‹è¯•æ‰§è¡Œå®Œæˆ"
        echo "Job çŠ¶æ€: ${{ job.status }}"
        echo "æ„å»ºæ­¥éª¤çŠ¶æ€: ${{ steps.build.outcome }}"
        echo "æ“ä½œç³»ç»Ÿ: ${{ matrix.os }}"

  # Job 3: å®‰å…¨æ‰«æ
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Dependency scan
      run: |
        echo "æ‰§è¡Œä¾èµ–é¡¹å®‰å…¨æ‰«æ..."
        echo "æ£€æŸ¥å·²çŸ¥æ¼æ´..."
    
    - name: Code vulnerability scan
      run: |
        echo "æ‰§è¡Œä»£ç æ¼æ´æ‰«æ..."
        echo "SAST åˆ†æä¸­..."
    
    - name: Container scan
      run: |
        echo "æ‰§è¡Œå®¹å™¨é•œåƒæ‰«æ..."
        echo "Docker å®‰å…¨æ‰«æ..."
    
    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security-scans/
        retention-days: 30

  # Job 4: éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    
    # æ¸…æ™°çš„ç¯å¢ƒæ¡ä»¶åˆ¤æ–­
    if: ${{ github.event.inputs.environment == 'staging' || github.event.inputs.environment != 'production' }}
    
    # ç¯å¢ƒé…ç½®
    environment: 
      name: staging
      url: https://staging.example.com
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: dist/
    
    - name: Setup deployment
      run: |
        echo "å‡†å¤‡éƒ¨ç½²åˆ° staging ç¯å¢ƒ"
        echo "éƒ¨ç½²æ ‡ç­¾: ${{ github.event.inputs.tags || 'latest' }}"
        echo "è°ƒè¯•æ¨¡å¼: ${{ github.event.inputs.debug || false }}"
        echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
    
    - name: Deploy application
      run: |
        echo "æ‰§è¡Œéƒ¨ç½²æ“ä½œåˆ° staging..."
        echo "ä½¿ç”¨ç¯å¢ƒå¯†é’¥"
    
    - name: Health check
      run: |
        echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        echo "éªŒè¯éƒ¨ç½²çŠ¶æ€..."
        echo "åº”ç”¨URL: ${{ environment.url }}"

  # Job 5: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆéœ€è¦å®¡æ‰¹ï¼‰
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    
    # æ¸…æ™°çš„ç”Ÿäº§ç¯å¢ƒæ¡ä»¶
    if: ${{ github.event.inputs.environment == 'production' || github.ref == 'refs/heads/main' }}
    
    # ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼ˆéœ€è¦å®¡æ‰¹ï¼‰
    environment: 
      name: production
      url: https://production.example.com
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: dist/
    
    - name: Setup production deployment
      run: |
        echo "å‡†å¤‡éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
        echo "è¿™æ˜¯ä¸€ä¸ªå—ä¿æŠ¤çš„ç¯å¢ƒï¼Œéœ€è¦å®¡æ‰¹"
        echo "éƒ¨ç½²æ ‡ç­¾: ${{ github.event.inputs.tags || 'latest' }}"
        echo "åˆ†æ”¯: ${{ github.ref }}"
    
    - name: Deploy to production
      run: |
        echo "æ‰§è¡Œç”Ÿäº§ç¯å¢ƒéƒ¨ç½²..."
        echo "ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒå¯†é’¥"
    
    - name: Production health check
      run: |
        echo "æ‰§è¡Œç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥..."
        echo "éªŒè¯ç”Ÿäº§éƒ¨ç½²çŠ¶æ€..."
        echo "ç”Ÿäº§ç¯å¢ƒURL: ${{ environment.url }}"

  # Job 6: é€šçŸ¥å’Œæ¸…ç†
  notify-and-cleanup:
    name: Notify and Cleanup
    runs-on: ubuntu-latest
    needs: 
      - deploy-staging
      - deploy-production
    if: always()
    
    outputs:
      workflow-status: ${{ steps.check-status.outputs.status }}
      deployment-message: ${{ steps.check-status.outputs.message }}
    
    steps:
    - name: Determine notification type
      id: check-status
      run: |
        # æ¸…æ™°çš„çŠ¶æ€åˆ¤æ–­é€»è¾‘
        if [[ "${{ needs.deploy-production.result }}" == "success" ]]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "message=ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸå®Œæˆï¼" >> $GITHUB_OUTPUT
        elif [[ "${{ needs.deploy-staging.result }}" == "success" ]]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "message=ğŸ‰ é¢„å‘å¸ƒç¯å¢ƒéƒ¨ç½²æˆåŠŸå®Œæˆï¼" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "message=âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—" >> $GITHUB_OUTPUT
        fi
    
    - name: Send notification
      run: |
        echo "å‘é€é€šçŸ¥: ${{ steps.check-status.outputs.message }}"
        echo "å·¥ä½œæµçŠ¶æ€: ${{ steps.check-status.outputs.status }}"
        echo "å·¥ä½œæµè¿è¡ŒID: ${{ github.run_id }}"
        echo "å·¥ä½œæµURL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "é¢„å‘å¸ƒç¯å¢ƒéƒ¨ç½²çŠ¶æ€: ${{ needs.deploy-staging.result }}"
        echo "ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²çŠ¶æ€: ${{ needs.deploy-production.result }}"
        echo "ä»£ç è´¨é‡æ£€æŸ¥çŠ¶æ€: ${{ needs.code-quality.result }}"
        echo "å®‰å…¨æ‰«æçŠ¶æ€: ${{ needs.security-scan.result }}"
    
    - name: Cleanup resources
      if: always()
      run: |
        echo "æ¸…ç†ä¸´æ—¶èµ„æº..."
        echo "åˆ é™¤ä¸´æ—¶æ–‡ä»¶..."
        echo "é‡Šæ”¾æ„å»ºç¼“å­˜..."
    
    - name: Update PR status
      if: ${{ github.event_name == 'pull_request' }}
      run: |
        echo "æ›´æ–° Pull Request çŠ¶æ€..."
        echo "æ·»åŠ æ„å»ºç»“æœè¯„è®º..."
        echo "PR ç¼–å·: ${{ github.event.pull_request.number }}"

  # Job 7: å¤šç¯å¢ƒæµ‹è¯•ç¤ºä¾‹
  multi-environment-test:
    name: Test on ${{ matrix.environment }}
    runs-on: ubuntu-latest
    needs: code-quality
    
    # æ¸…æ™°çš„å¤šç¯å¢ƒçŸ©é˜µå®šä¹‰
    strategy:
      matrix:
        environment: [development, staging, production]
        include:
          - environment: development
            api-url: https://dev-api.example.com
          - environment: staging
            api-url: https://staging-api.example.com
          - environment: production
            api-url: https://api.example.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Environment setup
      run: |
        echo "æµ‹è¯•ç¯å¢ƒ: ${{ matrix.environment }}"
        echo "API ç«¯ç‚¹: ${{ matrix.api-url }}"
        echo "æ‰§è¡Œç¯å¢ƒç‰¹å®šæµ‹è¯•..."
    
    - name: Run environment tests
      run: |
        echo "åœ¨ ${{ matrix.environment }} ç¯å¢ƒè¿è¡Œæµ‹è¯•"
        echo "è¿æ¥åˆ°: ${{ matrix.api-url }}"

# å·¥ä½œæµè¾“å‡º
outputs:
  deployment-url:
    description: "éƒ¨ç½²åçš„åº”ç”¨URL"
    value: ${{ needs.deploy-production.outputs.deployment-url || needs.deploy-staging.outputs.deployment-url }}
  build-status:
    description: "æ„å»ºçŠ¶æ€"
    value: ${{ needs.build-and-test.result }}
  security-status:
    description: "å®‰å…¨æ‰«æçŠ¶æ€"
    value: ${{ needs.security-scan.result }}